# ============================================
# Script PowerShell para autenticación con MSAL.PS
# Uso de flujo Device Code para obtener token de acceso
# ============================================

# Instala el módulo MSAL.PS en el alcance del usuario actual.
# Forzamos la instalación para asegurarnos de tener la última versión.
Install-Module -Name MSAL.PS -Scope CurrentUser -Force

#
# ============================================
# Configuración del entorno de autenticación
# ============================================

# ID del inquilino de Azure AD (Tenant ID)
$tenantId = '216525f5-ee44-4381-a1ac-224cf3ab3a73' # Reemplaza con tu Tenant ID

# ID de la aplicación registrada en Azure (Client ID)
$clientId = '04814e0a-7cd2-4a74-8677-900a71478e0f' # Reemplaza con tu Client ID

# Permisos requeridos para el token de acceso
# "User.Read": lectura básica del perfil del usuario
# "Files.ReadWrite.All": acceso completo de lectura/escritura a todos los archivos del usuario
$scopes = @("User.Read", "Files.ReadWrite.All")

# ============================================
# Solicitud del token de acceso con flujo Device Code
# ============================================

# Se solicita el token mediante el flujo Device Code
# Ideal para entornos donde no se puede abrir un navegador directamente

$token = Get-MsalToken -ClientId $clientId -TenantId $tenantId -Scopes $scopes -DeviceCode

# Se extrae el token de acceso del objeto recibido

$accessToken = $token.AccessToken

# Se imprime el token por consola (solo para depuración o demostración)
# En producción, evita mostrar tokens por seguridad

Write-Host "Access Token: $accessToken"

# ============================================
# Ejecución de un script PHP con el token obtenido
# ============================================

# Se llama al script PHP pasando el token como argumento
# El script se asume que convierte JSON (de Graph API) a CSV

php "$PSScriptRoot/jsonExportToOneDrive.php" $accessToken














































































































































































































































































































































































































































































































































































































































































































































































